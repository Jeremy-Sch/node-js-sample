version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2004:current
      docker_layer_caching: true
    resource_class: large
    steps:
      - run: 
          name: Pulling the Docker Image
          command: docker pull jeremysouche/node-js-sample:latest
      - run: 
          name: Creating the container
          command: docker run -d --name node-js-app jeremysouche/node-js-sample:latest
      - run:
          name: Installing curl
          command: apt update && apt install -y curl
      - run: 
          name: Validate that service is working
          command: |
            if [ "$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)" != "200" ]; then
              echo "Application did not return HTTP 200 OK."
              exit 1
            fi

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
